# Domain Entities -- UOW-03: Tasks & Kanban Board

## Overview

This document expands the Task entity stub defined in UOW-01 into its full specification for UOW-03. Includes the complete Prisma model, enum definitions, TypeScript types, JSON field schemas, indexes, and relations. The PipelineRun entity is referenced but not expanded here (deferred to UOW-04).

---

## Task Entity (Full Expansion)

The core entity for UOW-03. Represents a coding task on the Kanban board, owned by a Project.

### Prisma Schema

```prisma
model Task {
  id            String       @id @default(cuid())
  title         String       @db.VarChar(200)
  description   String?      @db.Text
  category      String       @default("feature")     // enum: TaskCategory
  priority      String       @default("medium")       // enum: TaskPriority
  status        String       @default("backlog")      // enum: TaskStatus
  pipelineState Json?                                 // PipelineStateJson
  subtasks      Json?                                 // SubtaskJson[]
  projectId     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pipelineRuns  PipelineRun[]

  // Indexes
  @@index([projectId, status])       // Kanban board queries: group by status within project
  @@index([projectId, createdAt])    // Ordering: newest first within project
  @@map("task")
}
```

### Field Definitions

| Field | Type | Constraints | Description |
|-------|------|------------|-------------|
| id | String | PK, cuid() | Unique task identifier |
| title | String | required, 1-200 chars, VarChar(200) | Task title displayed on card and detail view |
| description | String? | optional, max 5000 chars, Text | Detailed task description provided by user |
| category | String | required, enum value, default: "feature" | Task categorization for filtering and badge display |
| priority | String | required, enum value, default: "medium" | Task priority for triage |
| status | String | required, enum value, default: "backlog" | Current Kanban column. Updated by DnD or pipeline auto-move. |
| pipelineState | Json? | optional, structured JSON | Current pipeline execution state. Null when no pipeline has run. |
| subtasks | Json? | optional, JSON array | Ordered subtask list generated by Planner agent. Null until first pipeline run. |
| projectId | String | FK -> Project.id, required | Parent project. Tasks are scoped and queried by project. |
| createdAt | DateTime | auto, default: now() | Record creation timestamp |
| updatedAt | DateTime | auto, @updatedAt | Last modification timestamp. Updated on any field change. |

### Indexes

| Index | Fields | Purpose |
|-------|--------|---------|
| Primary | `id` | Unique lookup |
| Composite 1 | `(projectId, status)` | Kanban board query: `WHERE projectId = ? GROUP BY status` |
| Composite 2 | `(projectId, createdAt)` | List query with ordering: `WHERE projectId = ? ORDER BY createdAt DESC` |

### Relations

| Relation | Target | Type | FK | Cascade |
|----------|--------|------|-----|---------|
| project | Project | N:1 | Task.projectId -> Project.id | Delete: Cascade (project deletion removes all tasks) |
| pipelineRuns | PipelineRun | 1:N | PipelineRun.taskId -> Task.id | Delete: Cascade (task deletion removes all pipeline runs) |

---

## Enum Definitions

### TaskCategory

Stored as String in Prisma (no native Prisma enum). Validated via Zod enum on input.

| Value | Display Label | Badge Color (bg/text) |
|-------|-------------|----------------------|
| `feature` | Feature | blue-100 / blue-700 |
| `bug-fix` | Bug Fix | red-100 / red-700 |
| `refactoring` | Refactoring | yellow-100 / yellow-700 |
| `performance` | Performance | green-100 / green-700 |
| `security` | Security | purple-100 / purple-700 |
| `ui-ux` | UI/UX | pink-100 / pink-700 |

### TaskPriority

| Value | Display Label | Icon / Visual |
|-------|-------------|--------------|
| `low` | Low | Down arrow, muted text |
| `medium` | Medium | Dash, default text |
| `high` | High | Up arrow, orange text |
| `critical` | Critical | Double up arrow, red text |

### TaskStatus (Kanban Columns)

| Value | Display Label | Column Position | Description |
|-------|-------------|----------------|-------------|
| `backlog` | Backlog | 1 | Newly created, not yet started |
| `spec` | Spec | 2 | Planner agent generating subtasks |
| `building` | Building | 3 | Coder agent writing code |
| `review` | Review | 4 | Awaiting human review of AI output |
| `done` | Done | 5 | Approved and completed |

---

## JSON Field Schemas

### pipelineState (Json?)

Tracks the current pipeline execution state for real-time UI display. Updated by SSE events.

```ts
interface PipelineStateJson {
  phase: "planning" | "coding" | "reviewing" | "fixing" | "completed" | "failed";
  iteration: number;       // Current iteration (1-3)
  isActive: boolean;       // True when pipeline is running
  startedAt?: string;      // ISO timestamp of pipeline start
  completedAt?: string;    // ISO timestamp of pipeline completion
  failureReason?: string;  // Error message if failed
}
```

**Example values**:

```json
// No pipeline run yet
null

// Planner running
{
  "phase": "planning",
  "iteration": 1,
  "isActive": true,
  "startedAt": "2026-02-26T14:30:00.000Z"
}

// Coder running, second iteration (after review fail)
{
  "phase": "fixing",
  "iteration": 2,
  "isActive": true,
  "startedAt": "2026-02-26T14:30:00.000Z"
}

// Pipeline completed successfully
{
  "phase": "completed",
  "iteration": 1,
  "isActive": false,
  "startedAt": "2026-02-26T14:30:00.000Z",
  "completedAt": "2026-02-26T14:32:15.000Z"
}

// Pipeline failed
{
  "phase": "failed",
  "iteration": 3,
  "isActive": false,
  "startedAt": "2026-02-26T14:30:00.000Z",
  "completedAt": "2026-02-26T14:35:00.000Z",
  "failureReason": "Max retries exhausted. Reviewer found persistent issues."
}
```

### subtasks (Json?)

Ordered list of subtasks generated by the Planner agent. Each subtask tracks individual completion status.

```ts
interface SubtaskJson {
  id: string;             // Unique subtask ID (e.g., "st-1", "st-2")
  title: string;          // Short subtask title
  description?: string;   // Detailed description for Coder agent
  status: "pending" | "in-progress" | "completed" | "failed";
  order: number;          // Execution order (1-based)
}
```

**Example value**:

```json
[
  {
    "id": "st-1",
    "title": "Create database migration",
    "description": "Add users table with email, password_hash, name columns",
    "status": "completed",
    "order": 1
  },
  {
    "id": "st-2",
    "title": "Implement user registration endpoint",
    "description": "POST /api/auth/register with Zod validation",
    "status": "in-progress",
    "order": 2
  },
  {
    "id": "st-3",
    "title": "Add registration form component",
    "description": "React form with email, password, confirm password fields",
    "status": "pending",
    "order": 3
  }
]
```

---

## TypeScript Type Definitions

### types/task.ts (Full -- replaces UOW-01 stub)

```ts
// --- Enums ---

export const TASK_CATEGORIES = [
  "feature",
  "bug-fix",
  "refactoring",
  "performance",
  "security",
  "ui-ux",
] as const;

export type TaskCategory = (typeof TASK_CATEGORIES)[number];

export const TASK_PRIORITIES = ["low", "medium", "high", "critical"] as const;

export type TaskPriority = (typeof TASK_PRIORITIES)[number];

export const TASK_STATUSES = [
  "backlog",
  "spec",
  "building",
  "review",
  "done",
] as const;

export type TaskStatus = (typeof TASK_STATUSES)[number];

// --- Display Mappings ---

export const CATEGORY_LABELS: Record<TaskCategory, string> = {
  feature: "Feature",
  "bug-fix": "Bug Fix",
  refactoring: "Refactoring",
  performance: "Performance",
  security: "Security",
  "ui-ux": "UI/UX",
};

export const PRIORITY_LABELS: Record<TaskPriority, string> = {
  low: "Low",
  medium: "Medium",
  high: "High",
  critical: "Critical",
};

export const STATUS_LABELS: Record<TaskStatus, string> = {
  backlog: "Backlog",
  spec: "Spec",
  building: "Building",
  review: "Review",
  done: "Done",
};

// --- Column Config ---

export const KANBAN_COLUMNS: {
  status: TaskStatus;
  label: string;
  emptyText: string;
}[] = [
  {
    status: "backlog",
    label: "Backlog",
    emptyText: "Drop tasks here or create a new one",
  },
  {
    status: "spec",
    label: "Spec",
    emptyText: "Tasks move here during planning",
  },
  {
    status: "building",
    label: "Building",
    emptyText: "Tasks move here during coding",
  },
  {
    status: "review",
    label: "Review",
    emptyText: "Tasks move here for review",
  },
  {
    status: "done",
    label: "Done",
    emptyText: "Completed tasks appear here",
  },
];

// --- JSON Schemas ---

export type SubtaskStatus = "pending" | "in-progress" | "completed" | "failed";

export interface Subtask {
  id: string;
  title: string;
  description?: string;
  status: SubtaskStatus;
  order: number;
}

export type PipelinePhase =
  | "planning"
  | "coding"
  | "reviewing"
  | "fixing"
  | "completed"
  | "failed";

export interface PipelineState {
  phase: PipelinePhase;
  iteration: number;
  isActive: boolean;
  startedAt?: string;
  completedAt?: string;
  failureReason?: string;
}

// --- Phase Color Mapping ---

export const PHASE_COLORS: Record<PipelinePhase | "idle", string> = {
  idle: "#6B7280",       // gray
  planning: "#F59E0B",   // amber
  coding: "#3B82F6",     // blue
  reviewing: "#8B5CF6",  // purple
  fixing: "#3B82F6",     // blue (same as coding -- it's a code fix)
  completed: "#22C55E",  // green
  failed: "#EF4444",     // red
};

// --- Core Entity ---

export interface Task {
  id: string;
  title: string;
  description: string | null;
  category: TaskCategory;
  priority: TaskPriority;
  status: TaskStatus;
  pipelineState: PipelineState | null;
  subtasks: Subtask[] | null;
  projectId: string;
  createdAt: string;   // ISO string (serialized from Date)
  updatedAt: string;   // ISO string (serialized from Date)
}

// --- API Input Types ---

export interface CreateTaskInput {
  title: string;
  description?: string;
  category: TaskCategory;
  priority: TaskPriority;
  projectId: string;
}

export interface UpdateTaskInput {
  title?: string;
  description?: string | null;
  category?: TaskCategory;
  priority?: TaskPriority;
  status?: TaskStatus;
}

// --- Filter Types ---

export interface TaskFilter {
  search: string;
  category: TaskCategory | null;
  priority: TaskPriority | null;
}

// --- Category Badge Colors ---

export const CATEGORY_BADGE_COLORS: Record<
  TaskCategory,
  { bg: string; text: string }
> = {
  feature: { bg: "bg-blue-100", text: "text-blue-700" },
  "bug-fix": { bg: "bg-red-100", text: "text-red-700" },
  refactoring: { bg: "bg-yellow-100", text: "text-yellow-700" },
  performance: { bg: "bg-green-100", text: "text-green-700" },
  security: { bg: "bg-purple-100", text: "text-purple-700" },
  "ui-ux": { bg: "bg-pink-100", text: "text-pink-700" },
};
```

### lib/validations/task-schemas.ts

```ts
import { z } from "zod";
import { TASK_CATEGORIES, TASK_PRIORITIES, TASK_STATUSES } from "@/types/task";

export const createTaskSchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(200, "Title must be 200 characters or fewer")
    .trim(),
  description: z
    .string()
    .max(5000, "Description must be 5000 characters or fewer")
    .optional()
    .or(z.literal("")),
  category: z.enum(TASK_CATEGORIES, {
    required_error: "Category is required",
  }),
  priority: z.enum(TASK_PRIORITIES, {
    required_error: "Priority is required",
  }),
  projectId: z.string().min(1, "Project ID is required"),
});

export const updateTaskSchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(200, "Title must be 200 characters or fewer")
    .trim()
    .optional(),
  description: z
    .string()
    .max(5000, "Description must be 5000 characters or fewer")
    .nullable()
    .optional(),
  category: z.enum(TASK_CATEGORIES).optional(),
  priority: z.enum(TASK_PRIORITIES).optional(),
  status: z.enum(TASK_STATUSES).optional(),
});

export const taskQuerySchema = z.object({
  projectId: z.string().min(1, "Project ID is required"),
  status: z.enum(TASK_STATUSES).optional(),
  category: z.enum(TASK_CATEGORIES).optional(),
  search: z.string().optional(),
});

export type CreateTaskSchema = z.infer<typeof createTaskSchema>;
export type UpdateTaskSchema = z.infer<typeof updateTaskSchema>;
export type TaskQuerySchema = z.infer<typeof taskQuerySchema>;
```

---

## Entity Relationship Context (UOW-03 Focus)

```
+----------------+       1:N       +----------------+       1:N       +----------------+
|    Project     |<--------------->|     Task       |<--------------->|  PipelineRun   |
|----------------|                 |----------------|                 |  (UOW-04)      |
| id (PK)        |                 | id (PK)        |                 |----------------|
| name           |                 | title          |                 | id (PK)        |
| userId (FK)    |                 | description?   |                 | taskId (FK)    |
| createdAt      |                 | category       |                 | phase          |
| updatedAt      |                 | priority       |                 | iteration      |
+----------------+                 | status         |                 | status         |
                                   | pipelineState? |                 | agentLogs?     |
                                   | subtasks?      |                 | fileChanges?   |
                                   | projectId (FK) |                 | startedAt      |
                                   | createdAt      |                 | completedAt?   |
                                   | updatedAt      |                 +----------------+
                                   +----------------+
                                     |
                                     | Indexes:
                                     | @@index([projectId, status])
                                     | @@index([projectId, createdAt])
```

---

## Data Lifecycle

| Event | Field Changes | Triggered By |
|-------|--------------|-------------|
| Task created (Create) | All fields set, status="backlog", pipelineState=null, subtasks=null | User via TaskCreationModal |
| Task created (Create & Start) | Same as above, then pipelineState set to `{phase:"planning", iteration:1, isActive:true}` | User via TaskCreationModal |
| Pipeline plan complete | subtasks populated, status="spec" | PipelineOrchestrator via SSE |
| Pipeline coding | status="building", pipelineState.phase="coding" | PipelineOrchestrator via SSE |
| Pipeline review | status="review", pipelineState.phase="reviewing" | PipelineOrchestrator via SSE |
| Pipeline auto-fix | pipelineState.phase="fixing", iteration incremented | PipelineOrchestrator via SSE |
| Pipeline complete | pipelineState.phase="completed", isActive=false | PipelineOrchestrator via SSE |
| Pipeline failed | pipelineState.phase="failed", isActive=false, failureReason set | PipelineOrchestrator via SSE |
| Manual drag | status changed to target column | User via DnD |
| Task edited | title/description/category/priority changed | User via TaskDetailView (future) |
| Task deleted | Record removed, cascades to PipelineRun | User via context menu |
